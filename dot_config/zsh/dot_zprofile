# ~/.config/zsh/.zprofile
# - Prefer Nix-provided tools (NIX_PROFILE_PREFIX) while allowing Homebrew (cask-only) integration.
# - Use brew shellenv when available, but keep Nix paths ahead to avoid priority inversion.

# Ensure unique path entries and seed PATH with known good roots
typeset -U path
path=(
  "$HOME/.local/bin"
  "/etc/profiles/per-user/$USER/bin"
  "/run/current-system/sw/bin"
  $path
)

# Choose profile prefix by checking where plugin layout actually exists.
# This is required because zsh plugins may be exposed either via per-user profile
# or via ~/.nix-profile depending on nix-darwin + home-manager integration.
if [[ -d "/etc/profiles/per-user/$USER/share/zsh/plugins" ]]; then
  export NIX_PROFILE_PREFIX="/etc/profiles/per-user/$USER"
elif [[ -d "$HOME/.nix-profile/share/zsh/plugins" ]]; then
  export NIX_PROFILE_PREFIX="$HOME/.nix-profile"
else
  unset NIX_PROFILE_PREFIX
fi

# Homebrew environment
# Prefer nix-homebrew unified launcher if present.
# NOTE: brew shellenv may prepend Homebrew paths; we re-assert Nix priority below.
if [[ -x /run/current-system/sw/bin/brew ]]; then
  eval "$(/run/current-system/sw/bin/brew shellenv)"
elif [[ -x /opt/homebrew/bin/brew ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Keep Nix paths ahead of Homebrew to avoid priority inversion.
# Ensure NIX_PROFILE_PREFIX/bin is the first entry if NIX_PROFILE_PREFIX is set.
if [[ -n "${NIX_PROFILE_PREFIX:-}" && -d "${NIX_PROFILE_PREFIX}/bin" ]]; then
  path=("${NIX_PROFILE_PREFIX}/bin" "${path[@]:#${NIX_PROFILE_PREFIX}/bin}")
fi

export PATH
